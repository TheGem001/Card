<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Chess - Play Friend or AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chess.js for Logic -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        :root {
            --board-light: #f0d9b5;
            --board-dark: #b58863;
            --highlight: rgba(255, 255, 0, 0.4);
            --last-move: rgba(155, 199, 0, 0.5);
            --valid-move: rgba(0, 0, 0, 0.1);
        }

        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 600px;
            border: 4px solid #333;
            user-select: none;
        }

        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            font-size: clamp(1.5rem, 8vw, 3rem);
        }

        .square.light { background-color: var(--board-light); }
        .square.dark { background-color: var(--board-dark); }
        
        .square.selected { background-color: var(--highlight) !important; }
        .square.last-move { background-color: var(--last-move) !important; }
        
        .move-dot {
            width: 25%;
            height: 25%;
            background: var(--valid-move);
            border-radius: 50%;
            pointer-events: none;
        }

        .piece {
            cursor: grab;
            transition: transform 0.1s;
            z-index: 10;
        }
        .piece:active { cursor: grabbing; }

        @media (max-width: 640px) {
            .chess-board { max-width: 95vw; }
        }

        .status-panel {
            scrollbar-width: thin;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-4 font-sans">

    <!-- Header -->
    <header class="text-center mb-6">
        <h1 class="text-4xl font-bold text-amber-500 mb-2"><i class="fas fa-chess-knight mr-2"></i>Grandmaster Royale</h1>
        <p class="text-slate-400">Challenge the engine or a friend locally.</p>
    </header>

    <main class="w-full max-w-6xl flex flex-col lg:flex-row gap-8 items-start justify-center">
        
        <!-- Left Side: Game Board -->
        <div class="flex-1 flex flex-col items-center w-full">
            <div id="board" class="chess-board shadow-2xl rounded overflow-hidden">
                <!-- Squares generated by JS -->
            </div>
            
            <div class="flex justify-between w-full max-w-[600px] mt-4 bg-slate-800 p-4 rounded-lg shadow-inner">
                <div id="status" class="font-semibold text-lg">White's Turn</div>
                <div id="game-mode-display" class="text-amber-400 italic">Mode: Player vs Computer</div>
            </div>
        </div>

        <!-- Right Side: Controls and Info -->
        <div class="w-full lg:w-80 flex flex-col gap-4">
            
            <!-- Game Controls -->
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Settings</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Game Mode</label>
                        <select id="mode-select" class="w-full bg-slate-700 border-none p-2 rounded text-white focus:ring-2 focus:ring-amber-500">
                            <option value="ai">vs Computer (AI)</option>
                            <option value="pvp">vs Friend (Local)</option>
                        </select>
                    </div>

                    <div id="ai-difficulty-container">
                        <label class="block text-sm text-slate-400 mb-2">AI Difficulty</label>
                        <select id="difficulty" class="w-full bg-slate-700 border-none p-2 rounded text-white focus:ring-2 focus:ring-amber-500">
                            <option value="0">Easy (Random)</option>
                            <option value="1">Medium</option>
                            <option value="2" selected>Hard</option>
                        </select>
                    </div>

                    <button id="reset-btn" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-redo"></i> New Game
                    </button>
                    
                    <button id="undo-btn" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-undo"></i> Undo Move
                    </button>
                </div>
            </div>

            <!-- History and Captures -->
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg flex-grow min-h-[300px] flex flex-col">
                <h2 class="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Match Data</h2>
                
                <div class="mb-4">
                    <p class="text-xs uppercase text-slate-500 font-bold mb-1">Captured Pieces</p>
                    <div id="captured-pieces" class="flex flex-wrap gap-1 text-2xl h-12">
                        <!-- Pieces added by JS -->
                    </div>
                </div>

                <p class="text-xs uppercase text-slate-500 font-bold mb-1">Move History</p>
                <div id="move-history" class="status-panel overflow-y-auto max-h-48 text-sm font-mono text-slate-300 bg-slate-900/50 p-2 rounded border border-slate-700">
                    <!-- History lines -->
                    <div class="text-slate-500 italic">No moves yet...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for Game Over -->
    <div id="game-over-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
        <div class="bg-slate-800 p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl border border-amber-500/30">
            <h2 id="modal-title" class="text-3xl font-bold text-amber-500 mb-2">Checkmate!</h2>
            <p id="modal-message" class="text-slate-300 mb-6">White has won the game.</p>
            <button id="modal-close" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded-xl transition-all">
                Play Again
            </button>
        </div>
    </div>

    <script>
        // Constants & State
        const PIECES = {
            'p': '♟', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚',
            'P': '♙', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔'
        };

        const game = new Chess();
        const boardEl = document.getElementById('board');
        const statusEl = document.getElementById('status');
        const historyEl = document.getElementById('move-history');
        const capturedEl = document.getElementById('captured-pieces');
        const modeSelect = document.getElementById('mode-select');
        const difficultySelect = document.getElementById('difficulty');
        const modeDisplay = document.getElementById('game-mode-display');
        const modal = document.getElementById('game-over-modal');

        let selectedSquare = null;
        let lastMove = null;

        // Initialize Board
        function createBoard() {
            boardEl.innerHTML = '';
            for (let i = 0; i < 64; i++) {
                const square = document.createElement('div');
                const row = Math.floor(i / 8);
                const col = i % 8;
                const isLight = (row + col) % 2 === 0;
                
                square.classList.add('square', isLight ? 'light' : 'dark');
                square.dataset.index = i;
                square.dataset.pos = String.fromCharCode(97 + col) + (8 - row);
                
                square.addEventListener('click', handleSquareClick);
                boardEl.appendChild(square);
            }
            updateBoard();
        }

        function updateBoard() {
            const position = game.board();
            const squares = boardEl.children;
            const history = game.history({ verbose: true });
            const last = history[history.length - 1];

            for (let i = 0; i < 64; i++) {
                const row = Math.floor(i / 8);
                const col = i % 8;
                const piece = position[row][col];
                const square = squares[i];
                
                square.innerHTML = '';
                square.classList.remove('selected', 'last-move');

                if (piece) {
                    const pieceEl = document.createElement('span');
                    pieceEl.className = 'piece';
                    pieceEl.textContent = PIECES[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                    square.appendChild(pieceEl);
                }

                // Highlight last move
                if (last && (square.dataset.pos === last.from || square.dataset.pos === last.to)) {
                    square.classList.add('last-move');
                }
            }

            updateStatus();
            updateHistory();
        }

        function handleSquareClick(e) {
            if (game.game_over()) return;
            
            // Prevent player from moving black pieces if AI mode
            if (modeSelect.value === 'ai' && game.turn() === 'b') return;

            const pos = e.currentTarget.dataset.pos;
            const piece = game.get(pos);

            // Clear previous highlights
            const dots = document.querySelectorAll('.move-dot');
            dots.forEach(d => d.remove());

            // If a square is already selected
            if (selectedSquare) {
                const move = game.move({
                    from: selectedSquare,
                    to: pos,
                    promotion: 'q' // Default to queen for simplicity
                });

                if (move) {
                    selectedSquare = null;
                    updateBoard();
                    
                    if (!game.game_over() && modeSelect.value === 'ai') {
                        setTimeout(makeAiMove, 500);
                    }
                    return;
                }
            }

            // Select a piece
            if (piece && piece.color === game.turn()) {
                selectedSquare = pos;
                
                // Visual selection
                document.querySelectorAll('.square').forEach(s => s.classList.remove('selected'));
                e.currentTarget.classList.add('selected');

                // Show valid moves
                const moves = game.moves({ square: pos, verbose: true });
                moves.forEach(m => {
                    const targetSquare = Array.from(boardEl.children).find(s => s.dataset.pos === m.to);
                    const dot = document.createElement('div');
                    dot.className = 'move-dot';
                    targetSquare.appendChild(dot);
                });
            } else {
                selectedSquare = null;
                document.querySelectorAll('.square').forEach(s => s.classList.remove('selected'));
            }
        }

        // Simple AI Logic
        function makeAiMove() {
            if (game.game_over()) return;

            const difficulty = parseInt(difficultySelect.value);
            const moves = game.moves();
            let move;

            if (difficulty === 0) {
                // Random
                move = moves[Math.floor(Math.random() * moves.length)];
            } else {
                // Basic Evaluation (Mini-version)
                move = getBestMove(game, difficulty);
            }

            game.move(move);
            updateBoard();
        }

        // Heuristic Evaluation for AI
        function evaluateBoard(game) {
            const weights = { p: 10, n: 30, b: 30, r: 50, q: 90, k: 900 };
            let total = 0;
            game.board().forEach(row => {
                row.forEach(p => {
                    if (p) {
                        const val = weights[p.type];
                        total += (p.color === 'w' ? val : -val);
                    }
                });
            });
            return total;
        }

        function getBestMove(game, depth) {
            const moves = game.moves();
            let bestMove = null;
            let bestValue = Infinity; // Looking for min value (Black is -ve)

            moves.forEach(m => {
                game.move(m);
                let boardValue = evaluateBoard(game);
                if (boardValue < bestValue) {
                    bestValue = boardValue;
                    bestMove = m;
                }
                game.undo();
            });

            return bestMove || moves[Math.floor(Math.random() * moves.length)];
        }

        function updateStatus() {
            let status = '';
            const moveColor = game.turn() === 'b' ? 'Black' : 'White';

            if (game.in_checkmate()) {
                status = `Game Over: ${moveColor} is in Checkmate.`;
                showGameOver(moveColor === 'White' ? 'Black Wins!' : 'White Wins!');
            } else if (game.in_draw()) {
                status = 'Game Over: Draw';
                showGameOver('Draw');
            } else {
                status = `${moveColor}'s Turn`;
                if (game.in_check()) status += ' (Check!)';
            }

            statusEl.textContent = status;
            
            // Update mode display
            modeDisplay.textContent = `Mode: ${modeSelect.value === 'ai' ? 'Player vs Computer' : 'Pass-and-Play'}`;
        }

        function updateHistory() {
            const history = game.history();
            historyEl.innerHTML = '';
            
            if (history.length === 0) {
                historyEl.innerHTML = '<div class="text-slate-500 italic">No moves yet...</div>';
                capturedEl.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 0; i < history.length; i += 2) {
                html += `<div class="py-1 border-b border-slate-800 flex justify-between">
                    <span class="text-slate-500 w-8">${Math.floor(i / 2) + 1}.</span>
                    <span class="flex-1">${history[i]}</span>
                    <span class="flex-1 text-right">${history[i + 1] || ''}</span>
                </div>`;
            }
            historyEl.innerHTML = html;
            historyEl.scrollTop = historyEl.scrollHeight;

            // Captured pieces tracking
            // Since chess.js doesn't track captured pieces directly, we compare start to current
            const startPieces = "rnbqkbnrppppppppPPPPPPPPRNBQKBNR";
            const currentPieces = game.board().flat().filter(p => p).map(p => p.color === 'w' ? p.type.toUpperCase() : p.type).join('');
            
            let captured = startPieces;
            for (const char of currentPieces) {
                captured = captured.replace(char, '');
            }
            
            capturedEl.innerHTML = captured.split('').map(p => `<span class="opacity-70">${PIECES[p]}</span>`).join('');
        }

        function showGameOver(msg) {
            document.getElementById('modal-title').textContent = msg;
            document.getElementById('modal-message').textContent = game.in_checkmate() ? "Checkmate achieved." : "The match ended in a draw.";
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Event Listeners
        document.getElementById('reset-btn').onclick = () => {
            game.reset();
            selectedSquare = null;
            updateBoard();
        };

        document.getElementById('undo-btn').onclick = () => {
            game.undo();
            if (modeSelect.value === 'ai') game.undo(); // Undo AI move too
            updateBoard();
        };

        document.getElementById('modal-close').onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            game.reset();
            updateBoard();
        };

        modeSelect.onchange = () => {
            document.getElementById('ai-difficulty-container').style.display = modeSelect.value === 'ai' ? 'block' : 'none';
            updateStatus();
        };

        // Start
        createBoard();

    </script>
</body>
</html>

